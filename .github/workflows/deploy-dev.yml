name: Deploy to Development

on:
  push:
    branches:
      - develop
    paths-ignore:
      - "**.md"
      - ".gitignore"

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::879381259059:role/github-oidc-role
          role-session-name: github-staff-my-page
          aws-region: ap-northeast-1

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to ECR
        uses: docker/login-action@v3
        with:
          registry: 879381259059.dkr.ecr.ap-northeast-1.amazonaws.com

      - name: Set tag name
        run: |
          echo "DOCKER_TAG=dev-${GITHUB_SHA::7}" >> $GITHUB_ENV
          echo "GitHub SHA: ${{ github.sha }}"

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          platform: linux/amd64
          provenance: false
          build-args: |
            VITE_API_BASE_URL=${{ secrets.DEV_API_BASE_URL }}
            VITE_APP_ENV=development
            VITE_ENABLE_MOCK_API=false
            COMMIT_HASH=${{ github.sha }}
          tags: |
            879381259059.dkr.ecr.ap-northeast-1.amazonaws.com/staff-my-page:${{ env.DOCKER_TAG }}
            879381259059.dkr.ecr.ap-northeast-1.amazonaws.com/staff-my-page:latest-beta
